# agents/moderator.py

from typing import Tuple
from gigachat_api import chat_with_gigachat_messages

MODERATOR_PROMPT = (
    "Ты — Moderator, маршрутизатор запросов пользователя между несколькими агентами.\n"
    "\n"
    "У тебя есть 4 агента:\n"
    "1 — Tutor: объясняет материал, отвечает на теоретические и обучающие вопросы.\n"
    "2 — Examiner: составляет тесты по теме, проверяет знания пользователя по теме.\n"
    "3 — Analyzer: анализирует результаты тестов, успеваемость, ошибки, прогресс.\n"
    "4 — Problem Solver: разбивает сложную тему или вопрос на 3 простых шага и объясняет их пошагово.\n"
    "\n"
    "Также у тебя есть понятие 'текущая тема' (topic). Она запоминается снаружи и "
    "используется, например, чтобы Examiner делал тест по последней изученной теме.\n"
    "\n"
    "Твоя задача — по тексту сообщения пользователя определить:\n"
    "1) Какого агента нужно вызвать (1, 2, 3 или 4).\n"
    "2) Нужно ли обновить 'текущую тему' на текст этого сообщения (1 — да, 0 — нет).\n"
    "\n"
    "Правила выбора агента:\n"
    "- Если пользователь просит что-то объяснить, узнать, разобрать теорию — выбери Tutor (1).\n"
    "- Если пользователь явно хочет тест/проверку/викторину по теме — выбери Examiner (2).\n"
    "- Если сообщение пользователя похоже на ответы к тесту (например: '1A 2C 3B', '1 a, 2 c, 3 d', 'ABCD'), то выбери Analyzer (3) и НЕ меняй тему (второе число = 0)."
    "- Если пользователь говорит, что НЕ понимает какую-то тему и просит объяснить по шагам, проще, частями,\n"
"  например: 'объясни по шагам', 'разбей это на этапы', 'я не понимаю этот шаг, объясни медленно',\n"
"  тогда выбери Problem Solver (4).\n"
    "\n"
    "Правила обновления темы (второе число):\n"
    "- Если пользователь задаёт НОВУЮ тему или формулирует теоретический вопрос, который задаёт контекст для обучения,\n"
    "  например: 'Расскажи про планеты Солнечной системы', 'Объясни, что такое интеграл', — установи второе число 1 (обновить topic).\n"
    "- Если пользователь просит ПРОДОЛЖИТЬ или УГЛУБИТЬ текущую тему, например: 'расскажи ещё', 'продолжай',\n"
    "  'write me more', 'поясни подробнее', 'сделай тест по этой теме', — не меняй тему: второе число 0.\n"
    "- Если сообщение явно не задаёт новую тему (короткая фраза без нового предмета разговора), тоже ставь 0.\n"
    "- Любая фраза вида 'тест по <тема>' или 'test about <topic>' — это НОВАЯ тема, ставь второе число 1.\n"
    "- Фразы 'по этой теме', 'on this topic', 'about it' — использовать существующую тему, второе число 0.\n"
    "\n"
    "ФОРМАТ ОТВЕТА:\n"
    "Ответь СТРОГО двумя числами через пробел, БЕЗ дополнительных слов, комментариев и символов.\n"
    "Первое число — агент (1, 2, 3 или 4).\n"
    "Второе число — флаг изменения темы (1 — обновить topic этим сообщением, 0 — оставить старую тему).\n"
    "\n"
    "Примеры:\n"
    "Вопрос: 'Расскажи про планеты Солнечной системы' → ответ: '1 1'\n"
    "Вопрос: 'Сделай тест по этой теме' → ответ: '2 0'\n"
    "Вопрос: 'Сделай тест по производным' → ответ: '2 1'\n"
    "Вопрос: 'Сделай тест по птицам' → ответ: '2 1'\n"
    "Вопрос: 'Give me a test about planets' → ответ: '2 1'\n"
    "Вопрос: 'Give me a test about birds' → ответ: '2 1'\n"
    "Вопрос: 'Make a test on this topic' → ответ: '2 0'\n"
    "Вопрос: 'Разбери мои ошибки в последнем тесте' → ответ: '3 0'\n"
    "Вопрос: 'Реши уравнение x^2 - 5x + 6 = 0' → ответ: '4 1'\n"
    "Вопрос: 'Я не понимаю, что такое интеграл, объясни по шагам' → ответ: '4 1'\n"
    "Вопрос: 'Explain this slowly step by step: Newton's second law' → ответ: '4 1'\n"
    "Вопрос: 'I still don’t get this part, can you break it down into steps?' → ответ: '4 0'\n"
    "Вопрос: 'Продолжай, расскажи ещё' → ответ: '1 0'\n"
    "\n"
    "Никаких других форматов не используй, только два числа через пробел.\n"
)


def run_moderator(access_token: str, user_message: str) -> Tuple[int, int]:
    """
    Вызывает модератора и возвращает (agent_id, change_topic_flag).
    agent_id: 1=Tutor, 2=Examiner, 3=Analyzer, 4=Problem Solver
    change_topic_flag: 1=обновить тему, 0=оставить.
    """
    prompt = [
        {"role": "system", "content": MODERATOR_PROMPT},
        {"role": "user", "content": user_message},
    ]

    raw_answer = chat_with_gigachat_messages(access_token, prompt)

    # Ожидаем формат "X Y"
    parts = raw_answer.strip().split()
    try:
        agent_id = int(parts[0])
    except Exception:
        agent_id = 1  # по умолчанию Tutor

    try:
        change_flag = int(parts[1])
    except Exception:
        change_flag = 0  # по умолчанию не менять тему

    # небольшой санити-чек
    if agent_id not in (1, 2, 3, 4):
        agent_id = 1
    if change_flag not in (0, 1):
        change_flag = 0

    return agent_id, change_flag
